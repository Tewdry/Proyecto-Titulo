{% extends 'Base/base.html' %}
{% load static %}

{% block head %}
<title>üèãÔ∏è Recomendador AthletIA</title>
<link rel="stylesheet" href="{% static 'css/ia_recomendador.css' %}">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% endblock %}

{% block content %}

<div class="ia-wrapper container-xl mt-5 mb-5">

  <!-- HERO IA -->
  <div class="ia-hero text-center mb-4">
    <span class="ia-badge-version">ü§ñ AthletIA ¬∑ Salud + Habitos</span>
    <h2 class="ia-title">
      Recomendador de Rutinas <span class="ia-title-highlight">AthletIA</span>
    </h2>
    <p class="ia-subtitle">
      Combinamos tu salud, h√°bitos y objetivos para crear una rutina
      realmente personalizada y segura. Completa los datos y deja que la IA haga el resto.
    </p>
    <a href="{% url 'ia:generar_rutina' %}" class="btn btn-ia-main w-10">
      Volver
    </a>
  </div>

  <!-- CARD PRINCIPAL -->
  <div class="ia-card">

    <form id="form">
      {% csrf_token %}

      <!-- 01 ¬∑ Datos generales -->
      <div class="ia-section">
        <div class="ia-section-header">
          <span class="ia-section-tag">01</span>
          <div>
            <h5>Datos generales</h5>
            <p>Edad, condici√≥n actual y objetivo principal de tu entrenamiento.</p>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-md-3 col-6">
            <label for="edad" class="ia-label">Edad</label>
            <input type="number" class="form-control ia-input" id="edad"
                   placeholder="Ej: 25"
                   value="{{ datos.age|default_if_none:'' }}">
          </div>
          <div class="col-md-3 col-6">
            <label for="imc" class="ia-label">IMC</label>
            <input type="text" class="form-control ia-input" id="imc"
                   placeholder="Ej: 23.5"
                   value="{{ datos.bmi|default_if_none:'' }}">
          </div>
          <div class="col-md-3 col-6">
            <label for="ritmo_cardiaco" class="ia-label">Ritmo card√≠aco (ppm)</label>
            <input type="number" class="form-control ia-input" id="ritmo_cardiaco"
                   placeholder="Ej: 70"
                   value="{{ datos.hr|default_if_none:'' }}">
          </div>
          <div class="col-md-3 col-6">
            <label for="duracion_min" class="ia-label">Duraci√≥n Rutina (min)</label>
            <input type="number" class="form-control ia-input" id="duracion_min"
                   placeholder="Ej: 40"
                   value="{{ datos.duration|default_if_none:'' }}">
          </div>
        </div>

        <div class="row g-3 mt-2">
          <div class="col-md-4">
            <label for="calorias_quemadas" class="ia-label">Calor√≠as por sesi√≥n</label>
            <input type="number" class="form-control ia-input" id="calorias_quemadas"
                   placeholder="Ej: 250"
                   value="{{ datos.calories|default_if_none:'' }}">
          </div>
          <div class="col-md-4">
            <label for="objetivo" class="ia-label">Objetivo principal</label>
            <select id="objetivo" class="form-select ia-input">
              {% for obj in objetivos %}
                <option value="{{ obj.nombre }}"
                        {% if obj.nombre == datos.goal %}selected{% endif %}>
                  {{ obj.nombre }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label for="nivel_experiencia" class="ia-label">Nivel de experiencia</label>
            <select id="nivel_experiencia" class="form-select ia-input">
              <option value="Principiante"
                {% if datos.experience == 'Principiante' %}selected{% endif %}>
                Principiante
              </option>
              <option value="Intermedio"
                {% if datos.experience == 'Intermedio' or not datos.experience %}selected{% endif %}>
                Intermedio
              </option>
              <option value="Avanzado"
                {% if datos.experience == 'Avanzado' %}selected{% endif %}>
                Avanzado
              </option>
            </select>
          </div>
        </div>
      </div>

      <!-- 02 ¬∑ Salud -->
      <div class="ia-section">
        <div class="ia-section-header">
          <span class="ia-section-tag">02</span>
          <div>
            <h5>Salud y antecedentes</h5>
            <p>Consideramos tus riesgos para ajustar la intensidad de forma segura.</p>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-md-4">
            <label for="fuma" class="ia-label">¬øFuma?</label>
            <select id="fuma" class="form-select ia-input">
              <option>No</option>
              <option>S√≠</option>
            </select>
          </div>
          <div class="col-md-4">
            <label for="bebe" class="ia-label">¬øBebe alcohol?</label>
            <select id="bebe" class="form-select ia-input">
              <option>No</option>
              <option>S√≠</option>
            </select>
          </div>
        </div>

        <div class="row g-3 mt-2">
          <div class="col-md-6">
            <label for="lesiones_actuales" class="ia-label">Lesiones actuales</label>
            <select id="lesiones_actuales" class="form-select ia-input">
              <option>No tengo lesiones</option>
              <option>Lesi√≥n de hombro</option>
              <option>Lesi√≥n de rodilla</option>
              <option>Esguince</option>
              <option>Desgarro muscular</option>
              <option>Otra lesi√≥n leve</option>
            </select>
          </div>
          <div class="col-md-6">
            <label for="enfermedades_preexistentes" class="ia-label">Enfermedades preexistentes</label>
            <select id="enfermedades_preexistentes" class="form-select ia-input">
              <option>No poseo</option>
              <option>Asma</option>
              <option>Diabetes</option>
              <option>Hipertensi√≥n</option>
              <option>Problemas card√≠acos</option>
              <option>Otra enfermedad cr√≥nica</option>
            </select>
          </div>
        </div>
      </div>

      <!-- 03 ¬∑ Sue√±o -->
      <div class="ia-section">
        <div class="ia-section-header">
          <span class="ia-section-tag">03</span>
          <div>
            <h5>Sue√±o y recuperaci√≥n</h5>
            <p>Tu descanso es clave para decidir volumen, intensidad y tipo de rutina.</p>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-md-4">
            <label for="horas_dormidas" class="ia-label">Horas dormidas (promedio)</label>
            <select id="horas_dormidas" class="form-select ia-input">
              <option>Menos de 5 horas</option>
              <option>5 a 6 horas</option>
              <option>7 a 8 horas (√≥ptimo)</option>
              <option>M√°s de 8 horas</option>
            </select>
          </div>
          <div class="col-md-4">
            <label for="calidad_sueno" class="ia-label">Calidad del sue√±o</label>
            <select id="calidad_sueno" class="form-select ia-input">
              <option>Mala</option>
              <option>Regular</option>
              <option>Buena</option>
              <option>Excelente</option>
            </select>
          </div>
          <div class="col-md-4">
            <label for="despertares_nocturnos" class="ia-label">Despertares nocturnos</label>
            <select id="despertares_nocturnos" class="form-select ia-input">
              <option>Ninguno</option>
              <option>1 vez</option>
              <option>2 veces</option>
              <option>3 o m√°s veces</option>
            </select>
          </div>
        </div>
      </div>

      <!-- 04 ¬∑ Nutrici√≥n -->
      <div class="ia-section">
        <div class="ia-section-header">
          <span class="ia-section-tag">04</span>
          <div>
            <h5>Nutrici√≥n y prote√≠nas</h5>
            <p>Alineamos el esfuerzo del entrenamiento con tu ingesta cal√≥rica y de prote√≠nas.</p>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-md-6">
            <label for="tipo_comida_principal" class="ia-label">Tipo de comida principal</label>
            <select id="tipo_comida_principal" class="form-select ia-input">
              <option>Alta en prote√≠nas</option>
              <option>Balanceada</option>
              <option>Alta en carbohidratos</option>
              <option>Alta en grasas</option>
              <option>Vegetariana / Vegana</option>
              <option>R√°pida o ultraprocesada</option>
            </select>
          </div>
          <div class="col-md-6">
            <label for="calorias_diarias_aprox" class="ia-label">Calor√≠as diarias aproximadas</label>
            <select id="calorias_diarias_aprox" class="form-select ia-input">
              <option>Menos de 1500 kcal</option>
              <option>1500 - 2000 kcal</option>
              <option>2000 - 2500 kcal</option>
              <option>M√°s de 2500 kcal</option>
            </select>
          </div>
        </div>

        <div class="row g-3 mt-2">
          <div class="col-md-4">
            <label for="consumo_proteinas" class="ia-label">Consumo de prote√≠nas</label>
            <select id="consumo_proteinas" class="form-select ia-input">
              <option>Muy bajo</option>
              <option>Moderado</option>
              <option>Alto (seg√∫n objetivos)</option>
            </select>
          </div>
        </div>
      </div>

      <!-- 05 ¬∑ Metas finales -->
      <div class="ia-section">
        <div class="ia-section-header">
          <span class="ia-section-tag">05</span>
          <div>
            <h5>Metas f√≠sicas</h5>
            <p>Definimos cu√°nto quieres subir/bajar de peso y ajustar tu % de grasa corporal.</p>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-md-6">
            <label for="meta_peso_corporal" class="ia-label">Meta de peso corporal</label>
            <select id="meta_peso_corporal" class="form-select ia-input">
              <option>Subir 1-3 kg</option>
              <option>Subir 4-6 kg</option>
              <option>Bajar 1-3 kg</option>
              <option>Bajar 4-6 kg</option>
              <option>Mantener peso actual</option>
            </select>
          </div>
          <div class="col-md-6">
            <label for="meta_grasa_corporal" class="ia-label">Meta de grasa corporal</label>
            <select id="meta_grasa_corporal" class="form-select ia-input">
              <option>Menos del 10%</option>
              <option>Entre 10% y 15%</option>
              <option>Entre 16% y 20%</option>
              <option>M√°s del 20%</option>
            </select>
          </div>
        </div>
      </div>

      <!-- BOT√ìN IA -->
      <div class="mt-4">
        <button type="button" id="btnEnviar" class="btn btn-ia-main w-100">
          ‚ö° Obtener recomendaci√≥n IA
        </button>
      </div>

    </form>

    <!-- LOADER -->
    <div id="loader" class="ia-loader" style="display:none;">
      <div class="spinner-border" role="status"></div>
      <p class="mt-2">Analizando tus datos y generando tu plan personalizado‚Ä¶</p>
    </div>

    <!-- RESULTADOS IA -->
    <div id="resultado" class="ia-result mt-4"></div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("btnEnviar");
  const div = document.getElementById("resultado");
  const loader = document.getElementById("loader");

  async function obtenerRecomendacion() {
    loader.style.display = "block";
    div.innerHTML = "";

    const data = {
      edad: parseFloat(document.getElementById("edad").value) || 25,
      imc: parseFloat(document.getElementById("imc").value) || 23.5,
      ritmo_cardiaco: parseFloat(document.getElementById("ritmo_cardiaco").value) || 70,
      duracion_min: parseFloat(document.getElementById("duracion_min").value) || 40,
      calorias_quemadas: parseFloat(document.getElementById("calorias_quemadas").value) || 250,
      objetivo: document.getElementById("objetivo").value || "Mantener peso actual",
      nivel_experiencia: document.getElementById("nivel_experiencia").value || "Intermedio",
      fuma: document.getElementById("fuma").value,
      bebe: document.getElementById("bebe").value,
      lesiones_actuales: document.getElementById("lesiones_actuales").value,
      enfermedades_preexistentes: document.getElementById("enfermedades_preexistentes").value,
      horas_dormidas: document.getElementById("horas_dormidas").value,
      calidad_sueno: document.getElementById("calidad_sueno").value,
      despertares_nocturnos: document.getElementById("despertares_nocturnos").value,
      tipo_comida_principal: document.getElementById("tipo_comida_principal").value,
      calorias_diarias_aprox: document.getElementById("calorias_diarias_aprox").value,
      consumo_proteinas: document.getElementById("consumo_proteinas").value,
      meta_peso_corporal: document.getElementById("meta_peso_corporal").value,
      meta_grasa_corporal: document.getElementById("meta_grasa_corporal").value
    };

    try {
      const res = await fetch("{% url 'ia:recomendar_rutina' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify(data)
      });

      const json = await res.json();
      loader.style.display = "none";

      if (json.success) {
        let html = `
          <div class="ia-result-card fade-in">
            <p class="ia-result-main">
              üí™ Rutina recomendada: <b>${json.recommendation}</b>
            </p>
            <p class="ia-result-sub">
              üéØ Nivel ajustado por IA: <b>${json.nivel_experiencia}</b> ¬∑
              üìä Precisi√≥n estimada: <b>${json.precision_modelo}%</b>
            </p>
            <hr class="ia-divider">
            <h5 class="ia-top3-title">üèÜ Top 3 recomendaciones IA</h5>
        `;

        if (json.top3) {
          json.top3.forEach(r => {
            html += `
              <div class="ai-bar-label mt-2">
                ${r.rutina} <span class="ai-prob">(${r.probabilidad}%)</span>
              </div>
              <div class="ai-bar-container">
                <div class="ai-bar" style="--bar-width:${r.probabilidad}%;"></div>
              </div>`;
          });
        }

        if (json.ejercicios && json.ejercicios.length > 0) {
          html += `
            <h5 class="ia-top3-title mt-4">üìã Ejercicios sugeridos</h5>
            <div class="ia-exercises">
              <ul>`;
          json.ejercicios.forEach(e => {
            html += `<li>üèãÔ∏è‚Äç‚ôÇÔ∏è <b>${e.nombre}</b> ‚Äî <i>${e.descripcion}</i></li>`;
          });
          html += `</ul></div>`;
        }

        html += `
          <div class="text-center mt-4">
            <button id="btnAgendar" class="btn btn-outline-info px-4 rounded-pill">
              üìÖ Agendar esta rutina en el calendario
            </button>
          </div>
        </div>`;

        div.innerHTML = html;

        const btnAgendar = document.getElementById("btnAgendar");
        if (btnAgendar) {
          btnAgendar.addEventListener("click", () => mostrarModalAgendar(json));
        }

      } else {
        div.innerHTML = `<p class="text-danger">‚ö†Ô∏è ${json.error}</p>`;
      }
    } catch (err) {
      loader.style.display = "none";
      div.innerHTML = "<p class='text-danger'>‚ö†Ô∏è Error al conectar con el servidor.</p>";
    }
  }

  async function mostrarModalAgendar(json) {
    const { value: formValues } = await Swal.fire({
      title: "üìÖ Agendar rutina",
      html: `
        <p>Selecciona una fecha para <b>${json.recommendation}</b>:</p>
        <input type="date" id="fechaRutina" class="swal2-input">
        <textarea id="notasRutina" class="swal2-textarea" placeholder="Notas (opcional)"></textarea>
      `,
      focusConfirm: false,
      showCancelButton: true,
      confirmButtonText: "‚úÖ Guardar",
      cancelButtonText: "Cancelar",
      background: "#02161d",
      color: "#fff",
      confirmButtonColor: "#25e2d7",
      cancelButtonColor: "#d63031",
      preConfirm: () => {
        const fecha = document.getElementById("fechaRutina").value;
        const notas = document.getElementById("notasRutina").value;
        if (!fecha) {
          Swal.showValidationMessage("‚ö†Ô∏è Debes seleccionar una fecha.");
          return false;
        }
        return { fecha, notas };
      }
    });

    if (formValues) {
      const res = await fetch("{% url 'ia:registrar_rutina_calendario' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({
          fecha: formValues.fecha,
          notas: formValues.notas,
          rutina_id: json.id_rutina || 1
        })
      });

      const result = await res.json();

      if (result.success) {
        Swal.fire({
          icon: "success",
          title: "Rutina agendada üóìÔ∏è",
          text: result.message,
          background: "#02161d",
          color: "#fff"
        });
      } else {
        Swal.fire({
          icon: "error",
          title: "Error",
          text: result.error || "No se pudo agendar la rutina."
        });
      }
    }
  }

  btn.addEventListener("click", obtenerRecomendacion);
});
</script>

{% endblock %}
