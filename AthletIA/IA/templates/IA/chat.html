{% extends 'Base/base.html' %}
{% load static %}

{% block content %}
<div class="min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-cyan-700 to-emerald-500 p-6">
  <div class="w-full max-w-3xl bg-gray-900 text-white rounded-3xl shadow-2xl flex flex-col h-[85vh]">

    <!-- Header -->
    <div class="py-4 border-b border-gray-700 text-center">
      <h2 class="text-2xl font-extrabold text-emerald-400">ğŸ¤– Chat AthletIA v9</h2>
      <p class="text-gray-400 text-sm mt-1">Tu entrenador inteligente estÃ¡ listo para ayudarte ğŸ’ª</p>
    </div>

    <!-- Chat -->
    <div id="chat-box" class="flex-1 overflow-y-auto px-6 py-4 space-y-3 scroll-smooth">
      <div class="flex items-start">
        <div class="bg-emerald-700 text-white rounded-2xl px-4 py-3 max-w-[80%] shadow">
          ğŸ‘‹ Â¡Hola! Soy <strong>AthletIA</strong>. CuÃ©ntame un poco sobre ti para crear tu rutina ideal.
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="p-4 border-t border-gray-700 flex items-center space-x-3">
      <input id="mensaje" type="text"
        class="flex-1 p-3 rounded-xl text-gray-900 focus:outline-none focus:ring-2 focus:ring-emerald-400"
        placeholder="Escribe tu mensaje..." />
      <button id="enviar"
        class="bg-emerald-500 hover:bg-emerald-600 px-5 py-3 rounded-xl font-semibold flex items-center space-x-1 transition">
        <span>Enviar</span> ğŸš€
      </button>
    </div>
  </div>
</div>

<!-- JS -->
<script>
const chatBox = document.getElementById("chat-box");
const input = document.getElementById("mensaje");
const btn = document.getElementById("enviar");

btn.addEventListener("click", sendMessage);
input.addEventListener("keydown", e => { if (e.key === "Enter") sendMessage(); });

async function sendMessage() {
  const mensaje = input.value.trim();
  if (!mensaje) return;

  // Usuario
  chatBox.innerHTML += `
    <div class="flex justify-end">
      <div class="bg-blue-600 text-white rounded-2xl px-4 py-3 max-w-[80%] shadow">${mensaje}</div>
    </div>`;
  input.value = "";
  chatBox.scrollTop = chatBox.scrollHeight;

  // Indicador de escritura
  const typingDiv = document.createElement("div");
  typingDiv.id = "typing";
  typingDiv.className = "flex items-start";
  typingDiv.innerHTML = `
    <div class="bg-gray-700 text-gray-300 rounded-2xl px-4 py-3 shadow animate-pulse">
      <span class="italic text-sm">AthletIA estÃ¡ escribiendo...</span>
    </div>`;
  chatBox.appendChild(typingDiv);
  chatBox.scrollTop = chatBox.scrollHeight;

  try {
    const res = await fetch("/ia/chat/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ mensaje })
    });

    if (!res.ok) {
      throw new Error("Respuesta no vÃ¡lida del servidor (" + res.status + ")");
    }

    const data = await res.json();
    chatBox.removeChild(typingDiv);

    chatBox.innerHTML += `
      <div class="flex items-start">
        <div class="bg-emerald-700 text-white rounded-2xl px-4 py-3 max-w-[80%] shadow whitespace-pre-line">
          ${data.respuesta || "âš ï¸ Error procesando el mensaje."}
        </div>
      </div>`;
  } catch (err) {
    chatBox.innerHTML += `
      <div class="flex items-start">
        <div class="bg-red-600 text-white rounded-2xl px-4 py-3 max-w-[80%] shadow">
          âŒ Error al conectar con AthletIA: ${err.message}
        </div>
      </div>`;
  }

  chatBox.scrollTop = chatBox.scrollHeight;
}
</script>

{% endblock %}
